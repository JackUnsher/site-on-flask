# Руководство по развертыванию Flask-приложения на Amvera

## Содержание
1. [Подготовка репозитория](#подготовка-репозитория)
2. [Настройка вебхука в GitHub](#настройка-вебхука)
3. [Настройка проекта в Amvera](#настройка-проекта)
4. [Конфигурация переменных окружения](#переменные-окружения)
5. [Настройка постоянного хранилища](#настройка-хранилища)
6. [Мониторинг и логи](#мониторинг-и-логи)

## Подготовка репозитория <a name="подготовка-репозитория"></a>

Убедитесь, что в корне вашего репозитория есть следующие файлы:

1. `amvera.yml` - конфигурационный файл для Amvera
2. `requirements.txt` - список зависимостей Python
3. `gunicorn_config.py` - конфигурация Gunicorn
4. `app.py` - точка входа в приложение

## Настройка вебхука в GitHub <a name="настройка-вебхука"></a>

Если вебхук уже настроен, пропустите этот шаг. В противном случае:

1. В репозитории GitHub перейдите в раздел **Settings** > **Webhooks**
2. Нажмите **Add webhook**
3. В поле **Payload URL** введите URL вебхука из панели управления Amvera
4. В поле **Content type** выберите `application/json`
5. Выберите события, которые будут запускать вебхук (обычно `push`)
6. Нажмите **Add webhook**

## Настройка проекта в Amvera <a name="настройка-проекта"></a>

1. Войдите в панель управления Amvera (cloud.amvera.ru)
2. Нажмите **Создать приложение**
3. Выберите метод **Из GitHub**
4. Выберите репозиторий с вашим Flask-приложением
5. Выберите ветку для деплоя (обычно `main` или `master`)
6. Нажмите **Создать**

## Конфигурация переменных окружения <a name="переменные-окружения"></a>

В панели управления Amvera:

1. Перейдите в раздел **Переменные окружения**
2. Изменить переменную `SECRET_KEY` на более надежное значение
3. Другие настройки в файле `amvera.yml` уже содержат все необходимые переменные окружения:
   - `FLASK_APP=app.py` - путь к файлу приложения
   - `FLASK_CONFIG=production` - режим работы приложения
   - `DATABASE_URL=sqlite:///app.db` - путь к файлу SQLite базы данных

## Настройка постоянного хранилища <a name="настройка-хранилища"></a>

Для работы с SQLite в качестве постоянной базы данных в Amvera необходимо использовать persistent директории, которые сохраняются между развертываниями. Эта настройка уже добавлена в `amvera.yml`:

```yaml
persistent:
  - path: instance
    mountPath: /app/instance
```

Эта конфигурация:
1. Создает постоянную директорию `instance`
2. Монтирует ее по пути `/app/instance` внутри контейнера
3. Все файлы в этой директории сохраняются между перезапусками и обновлениями приложения

После первого деплоя приложения, база данных SQLite будет создана в этой директории и будет сохраняться даже при обновлении кода.

## Мониторинг и логи <a name="мониторинг-и-логи"></a>

1. В панели управления Amvera перейдите в раздел **Логи**
2. Здесь вы можете просматривать логи приложения в реальном времени
3. В разделе **Мониторинг** вы можете следить за производительностью приложения

## Настройка SSL и домена

1. В панели управления Amvera перейдите в раздел **Настройки**
2. В поле **Домены** добавьте ваш собственный домен
3. Следуйте инструкциям для настройки DNS и получения SSL-сертификата

## Автоматизация развертывания

Благодаря настроенному вебхуку, каждый push в выбранную ветку GitHub будет автоматически запускать процесс деплоя на Amvera.

Процесс деплоя включает:
1. Клонирование репозитория
2. Установку зависимостей из `requirements.txt`
3. Создание директории `instance` для хранения базы данных (если она еще не существует)
4. Выполнение миграций базы данных с помощью `flask db upgrade`
5. Запуск приложения с помощью Gunicorn

## Преимущества использования SQLite на Amvera

1. **Простота настройки** - не требуется дополнительная конфигурация внешней базы данных
2. **Экономия ресурсов** - не нужно выделять отдельные серверы или контейнеры для БД
3. **Автоматическое резервное копирование** - Amvera автоматически сохраняет данные из persistent директорий
4. **Легкость миграции** - при необходимости можно легко перейти на более мощную БД позже

## Решение проблем

Если у вас возникли проблемы с развертыванием:

1. Проверьте логи в панели управления Amvera
2. Убедитесь, что все необходимые переменные окружения настроены
3. Проверьте настройки вебхука в GitHub
4. Убедитесь, что в репозитории есть все необходимые файлы
5. Проверьте права доступа к директории `instance` в логах 