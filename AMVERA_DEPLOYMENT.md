# Руководство по развертыванию Flask-приложения на Amvera

## Содержание
1. [Подготовка репозитория](#подготовка-репозитория)
2. [Настройка вебхука в GitHub](#настройка-вебхука)
3. [Настройка проекта в Amvera](#настройка-проекта)
4. [Конфигурация переменных окружения](#переменные-окружения)
5. [Настройка постоянного хранилища](#настройка-хранилища)
6. [Мониторинг и логи](#мониторинг-и-логи)

## Подготовка репозитория <a name="подготовка-репозитория"></a>

Убедитесь, что в корне вашего репозитория есть следующие файлы:

1. `amvera.yml` - конфигурационный файл для Amvera
2. `requirements.txt` - список зависимостей Python
3. `gunicorn_config.py` - конфигурация Gunicorn
4. `app.py` - точка входа в приложение

### Структура конфигурационного файла

Файл `amvera.yml` имеет следующую структуру согласно документации Amvera:

```yaml
meta:
  environment: python
  toolchain:
    name: pip
    version: '3.11'

build:
  env:
    FLASK_APP: app.py
    FLASK_CONFIG: production
    DATABASE_URL: sqlite:///instance/app.db
    SECRET_KEY: your-production-secret-key-change-this

run:
  command: gunicorn -c gunicorn_config.py app:app
  persistenceMount: /app/instance
  https: true
  postDeploy:
    - pip install -r requirements.txt
    - mkdir -p /app/instance
    - flask db upgrade
  excludeFiles:
    - venv
    - .git
    - .pytest_cache
    - __pycache__
    - '*.pyc'
    - htmlcov
    - .coverage
```

## Настройка вебхука в GitHub <a name="настройка-вебхука"></a>

Если вебхук уже настроен, пропустите этот шаг. В противном случае:

1. В репозитории GitHub перейдите в раздел **Settings** > **Webhooks**
2. Нажмите **Add webhook**
3. В поле **Payload URL** введите URL вебхука из панели управления Amvera
4. В поле **Content type** выберите `application/json`
5. Выберите события, которые будут запускать вебхук (обычно `push`)
6. Нажмите **Add webhook**

## Настройка проекта в Amvera <a name="настройка-проекта"></a>

1. Войдите в панель управления Amvera (cloud.amvera.ru)
2. Нажмите **Создать приложение**
3. Выберите метод **Из GitHub**
4. Выберите репозиторий с вашим Flask-приложением
5. Выберите ветку для деплоя (обычно `main` или `master`)
6. Нажмите **Создать**

## Конфигурация переменных окружения <a name="переменные-окружения"></a>

Переменные окружения определены в разделе `build.env` файла `amvera.yml`:

```yaml
build:
  env:
    FLASK_APP: app.py
    FLASK_CONFIG: production
    DATABASE_URL: sqlite:///instance/app.db
    SECRET_KEY: your-production-secret-key-change-this
```

В панели управления Amvera вы можете дополнительно:

1. Перейти в раздел **Переменные окружения**
2. Изменить переменную `SECRET_KEY` на более надежное значение
3. Добавить другие переменные окружения, если необходимо

## Настройка постоянного хранилища <a name="настройка-хранилища"></a>

В Amvera существует три типа хранилища:
1. **Code** - директория с кодом, управляемая git (меняется при каждом пуше)
2. **Artifacts** - директория с результатами сборки (может быть утеряна при пересборке)
3. **Data** - постоянное хранилище, которое сохраняется между пересборками

Для работы с SQLite в качестве постоянной базы данных в Amvera используется постоянное хранилище. Эта настройка определена в `amvera.yml`:

```yaml
run:
  persistenceMount: /app/instance
```

Эта конфигурация:
1. Создает точку монтирования постоянного хранилища по пути `/app/instance` внутри контейнера
2. Все файлы в этой директории сохраняются между развертываниями и пересборками
3. База данных SQLite будет сохраняться автоматически, так как мы указали путь `sqlite:///instance/app.db`

В конфигурации `app.py` и `config.py` также учтено использование этого постоянного хранилища для SQLite базы данных.

### Важные моменты хранилища

- **Постоянность данных**: Файлы в постоянном хранилище сохраняются между повторными развертываниями и пересборками
- **Резервное копирование**: Amvera автоматически создает резервные копии данных из постоянного хранилища
- **Общее хранилище**: Если у вас несколько экземпляров приложения, они используют общее хранилище, что требует учета при проектировании приложения

## Мониторинг и логи <a name="мониторинг-и-логи"></a>

1. В панели управления Amvera перейдите в раздел **Логи**
2. Здесь вы можете просматривать логи приложения в реальном времени
3. В разделе **Мониторинг** вы можете следить за производительностью приложения

## Настройка SSL и домена

SSL поддержка включена в конфигурации:

```yaml
run:
  https: true
```

Для настройки собственного домена:

1. В панели управления Amvera перейдите в раздел **Настройки**
2. В поле **Домены** добавьте ваш собственный домен
3. Следуйте инструкциям для настройки DNS и получения SSL-сертификата

## Автоматизация развертывания

Благодаря настроенному вебхуку, каждый push в выбранную ветку GitHub будет автоматически запускать процесс деплоя на Amvera.

Процесс деплоя включает шаги, определенные в `postDeploy`:

```yaml
run:
  postDeploy:
    - pip install -r requirements.txt
    - mkdir -p /app/instance
    - flask db upgrade
```

Это обеспечивает:
1. Установку зависимостей из `requirements.txt`
2. Создание директории `/app/instance` для хранения базы данных (если она еще не существует)
3. Выполнение миграций базы данных с помощью `flask db upgrade`

## Исключение файлов из деплоя

Файлы, которые не должны быть включены в деплой, указаны в разделе `excludeFiles`:

```yaml
run:
  excludeFiles:
    - venv
    - .git
    - .pytest_cache
    - __pycache__
    - '*.pyc'
    - htmlcov
    - .coverage
```

## Преимущества использования SQLite с постоянным хранилищем на Amvera

1. **Простота настройки** - не требуется дополнительная конфигурация внешней базы данных
2. **Сохранность данных** - данные сохраняются между пересборками и обновлениями кода
3. **Автоматическое резервное копирование** - Amvera автоматически сохраняет данные из постоянного хранилища
4. **Экономия ресурсов** - не нужно выделять отдельные серверы или контейнеры для БД
5. **Легкость миграции** - при необходимости можно легко перейти на более мощную БД позже

## Решение проблем

Если у вас возникли проблемы с развертыванием:

1. Проверьте логи в панели управления Amvera
2. Убедитесь, что все необходимые переменные окружения настроены
3. Проверьте настройки вебхука в GitHub
4. Убедитесь, что в репозитории есть все необходимые файлы
5. Проверьте права доступа к директории `/app/instance` в логах
6. Просмотрите размер используемого постоянного хранилища в панели управления Amvera 